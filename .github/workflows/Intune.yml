# File: .github/workflows/Intune.yml
on: 
  push:
    branches: [ main ]

name: IntuneConfiguration

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      #location: "uksouth"
      #DeploymentDir: "Intune"
      #adminUsername: ${{ secrets.ADMIN_USERNAME }}
      #adminPassword: ${{ secrets.ADMIN_PASSWORD }}
      #artifactsLocation: "https://raw.githubusercontent.com/jonsmith79/AzureDevLab/main/Deployments"
      #artifactsLocationSasToken: ""
      azGroupPrefix: "SG"
      azBreakGlassGroupName: "CA-BreakGlass"
      azBreakGlassGroupDescription: "Break Glass Group for Azure Conditional Access Policies"
      azBreakGlassAccountDisplayName: "Break Glass"
      azBreakGlassAccountUPN: "Break.Glass@e2d.co.uk"
      azBreakGlassAccountPwd: ${{ secrets.ADMIN_PASSWORD }}

    steps:
    # Checkout code
    - name: Checkout
      uses: actions/checkout@main

    # Log into Azure
    - name: 'Az CLI Login'
      uses: azure/login@v1
      with:
        client-id: ${{secrets.AZURE_CLIENT_ID}}
        tenant-id: ${{secrets.AZURE_TENANT_ID}}
        #subscription-id: ${{secrets.AZURE_SUBSCRIPTION_ID}}
        allow-no-subscriptions: true

    
    # Create Azure AD Break Glass Group with Azure CLI
    # - name: Create Azure Break Glass Group
    #   uses: azure/CLI@v1
    #   with:
    #     azcliversion: 2.44.1
    #     inlineScript: az ad group create --display-name "${{env.azBreakGlassGroupName}}" --mail-nickname "${{env.azBreakGlassGroupName}}" --description "${{env.azBreakGlassGroupDescription}}"

    # Create Azure AD Break Glass Group with Azure CLI
    - name: 'Create Azure AD Break Glass Group'
      run: |
        azBGGroup=$(az ad group create --display-name "${{env.azGroupPrefix}}-${{env.azBreakGlassGroupName}}" --mail-nickname "${{env.azGroupPrefix}}-${{env.azBreakGlassGroupName}}" --description "${{env.azBreakGlassGroupDescription}}")

    # Create Azure AD Break Glass Account with Azure CLI
    - name: 'Create Azure AD Break Glass Account'
      run: |
        azBGUser=$(az ad user create --display-name "${{env.azBreakGlassAccountDisplayName}}" --password "${{env.azBreakGlassAccountPwd}}" --user-principal-name "${{env.azBreakGlassAccountUPN}}" --force-change-password-next-sign-in false)

    # Add Break Glass Account to Break Glass Group with Azure CLI
    - name: 'Add Break Glass Account to Break Glass Group'
      run: |
        az ad group member add --group $(azBGGroup) --member-id $(azBGUser)

    

    # # Deploy Bicep file
    # - name: Intune - GitHub Action Deployment
    #   uses: azure/arm-deploy@v1
    #   with:
    #     scope: subscription
    #     subscriptionId: ${{ secrets.AZURE_ADL_SUBID }}
    #     region: ${{env.location}}
    #     template: ./Deployments/${{env.DeploymentDir}}/deployIntune.bicep
    #     parameters:
    #       adminUsername="${{env.adminUsername}}"
    #       adminPassword="${{env.adminPassword}}"
    #       artifactsLocation="${{env.artifactsLocation}}/${{env.DeploymentDir}}/"
    #       artifactsLocationSasToken="${{env.artifactsLocationSasToken}}"
    #       azGroupPrefix="${{env.azGroupPrefix}}"
    #       azBreakGlassGroupName="${{env.azBreakGlassGroupName}}"

    # Az logout and security hardening
    - name: 'Az logout and security hardening'
      run: |
        az logout
        az cache purge
        az account clear  